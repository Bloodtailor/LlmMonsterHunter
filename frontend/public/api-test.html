<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test Script - Dungeon & Game State</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a2e;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #f39c12;
            text-align: center;
            border-bottom: 2px solid #2c5aa0;
            padding-bottom: 10px;
        }
        .test-section {
            background: #16213e;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #2c5aa0;
        }
        .test-section h2 {
            color: #4a90e2;
            margin-top: 0;
        }
        button {
            background: #f39c12;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        button:hover {
            background: #e67e22;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .result {
            background: #0f3460;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #27ae60;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            border-left-color: #e74c3c;
            background: #2d1b1b;
        }
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success { background: #27ae60; }
        .status.error { background: #e74c3c; }
        .status.pending { background: #f39c12; }
        #runAllTests {
            background: #27ae60;
            font-size: 16px;
            padding: 15px 30px;
        }
        .api-url {
            color: #4a90e2;
            font-weight: bold;
        }
        .test-controls {
            text-align: center;
            margin: 30px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Monster Hunter Game - API Test Suite</h1>
        <p style="text-align: center; color: #b0b0b0;">
            Testing all new Dungeon System and Game State Management APIs
        </p>

        <div class="test-controls">
            <button id="runAllTests">üöÄ Run All Tests</button>
            <button id="clearResults">üóëÔ∏è Clear Results</button>
        </div>

        <!-- Game State Tests -->
        <div class="test-section">
            <h2>üéØ Game State Management APIs</h2>
            
            <button onclick="testApi('GET', '/api/game-state', {}, 'gameStateResult')">
                GET /game-state
            </button>
            <button onclick="testApi('POST', '/api/game-state/reset', {}, 'resetGameResult')">
                POST /game-state/reset
            </button>
            <button onclick="testApi('GET', '/api/game-state/following', {}, 'followingResult')">
                GET /game-state/following
            </button>
            <button onclick="testApi('GET', '/api/game-state/party', {}, 'partyResult')">
                GET /game-state/party
            </button>
            <button onclick="testApi('GET', '/api/game-state/party/ready', {}, 'partyReadyResult')">
                GET /game-state/party/ready
            </button>

            <div id="gameStateResult" class="result" style="display: none;"></div>
            <div id="resetGameResult" class="result" style="display: none;"></div>
            <div id="followingResult" class="result" style="display: none;"></div>
            <div id="partyResult" class="result" style="display: none;"></div>
            <div id="partyReadyResult" class="result" style="display: none;"></div>
        </div>

        <!-- Party Management Tests -->
        <div class="test-section">
            <h2>üë• Party Management APIs</h2>
            
            <button onclick="testAddMonsterToFollowing()">
                POST /game-state/following/add (Test Monster)
            </button>
            <button onclick="testSetParty()">
                POST /game-state/party/set (Test Party)
            </button>
            <button onclick="testRemoveFromFollowing()">
                POST /game-state/following/remove (Remove Test Monster)
            </button>

            <div id="addFollowingResult" class="result" style="display: none;"></div>
            <div id="setPartyResult" class="result" style="display: none;"></div>
            <div id="removeFollowingResult" class="result" style="display: none;"></div>
        </div>

        <!-- Dungeon System Tests -->
        <div class="test-section">
            <h2>üè∞ Dungeon System APIs</h2>
            
            <button onclick="testApi('GET', '/api/dungeon/status', {}, 'dungeonStatusResult')">
                GET /dungeon/status
            </button>
            <button onclick="testApi('GET', '/api/dungeon/state', {}, 'dungeonStateResult')">
                GET /dungeon/state
            </button>
            <button onclick="testApi('POST', '/api/dungeon/enter', {}, 'dungeonEnterResult')">
                POST /dungeon/enter
            </button>

            <div id="dungeonStatusResult" class="result" style="display: none;"></div>
            <div id="dungeonStateResult" class="result" style="display: none;"></div>
            <div id="dungeonEnterResult" class="result" style="display: none;"></div>
        </div>

        <!-- Door Choice Tests -->
        <div class="test-section">
            <h2>üö™ Door Choice APIs</h2>
            <p style="color: #b0b0b0; font-size: 14px;">
                Note: These tests require being in a dungeon first
            </p>
            
            <button onclick="testChooseDoor('location_1')">
                POST /dungeon/choose-door (Location 1)
            </button>
            <button onclick="testChooseDoor('location_2')">
                POST /dungeon/choose-door (Location 2)
            </button>
            <button onclick="testChooseDoor('exit')">
                POST /dungeon/choose-door (Exit)
            </button>

            <div id="doorChoice1Result" class="result" style="display: none;"></div>
            <div id="doorChoice2Result" class="result" style="display: none;"></div>
            <div id="doorExitResult" class="result" style="display: none;"></div>
        </div>

        <!-- Monster API Integration -->
        <div class="test-section">
            <h2>üê≤ Monster API Integration</h2>
            
            <button onclick="testApi('GET', '/api/monsters?limit=5', {}, 'monstersListResult')">
                GET /monsters (First 5)
            </button>
            <button onclick="testApi('GET', '/api/monsters/stats', {}, 'monstersStatsResult')">
                GET /monsters/stats
            </button>

            <div id="monstersListResult" class="result" style="display: none;"></div>
            <div id="monstersStatsResult" class="result" style="display: none;"></div>
        </div>

    </div>

    <script>
        const API_BASE = 'http://localhost:5000';
        let testMonsterIds = []; // Store monster IDs for testing

        // Generic API test function
        async function testApi(method, endpoint, data = {}, resultElementId) {
            const resultElement = document.getElementById(resultElementId);
            resultElement.style.display = 'block';
            resultElement.className = 'result pending';
            resultElement.textContent = `üîÑ Testing ${method} ${endpoint}...`;

            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (method !== 'GET' && Object.keys(data).length > 0) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const result = await response.json();

                resultElement.className = response.ok ? 'result success' : 'result error';
                resultElement.textContent = `${method} ${endpoint}\n` +
                    `Status: ${response.status} ${response.statusText}\n` +
                    `Response: ${JSON.stringify(result, null, 2)}`;

                // Store monster IDs for party testing
                if (endpoint.includes('/monsters') && result.success && result.monsters) {
                    testMonsterIds = result.monsters.slice(0, 3).map(m => m.id);
                    console.log('Stored monster IDs for testing:', testMonsterIds);
                }

            } catch (error) {
                resultElement.className = 'result error';
                resultElement.textContent = `${method} ${endpoint}\n` +
                    `Error: ${error.message}\n` +
                    `Details: ${error.stack}`;
            }
        }

        // Specific test functions
        async function testAddMonsterToFollowing() {
            // First get a monster ID
            if (testMonsterIds.length === 0) {
                alert('Run "GET /monsters" first to get monster IDs for testing');
                return;
            }
            
            const monsterId = testMonsterIds[0];
            await testApi('POST', '/api/game-state/following/add', 
                { monster_id: monsterId }, 'addFollowingResult');
        }

        async function testSetParty() {
            if (testMonsterIds.length === 0) {
                alert('Run "GET /monsters" first to get monster IDs for testing');
                return;
            }

            const partyIds = testMonsterIds.slice(0, Math.min(3, testMonsterIds.length));
            await testApi('POST', '/api/game-state/party/set', 
                { monster_ids: partyIds }, 'setPartyResult');
        }

        async function testRemoveFromFollowing() {
            if (testMonsterIds.length === 0) {
                alert('Run "GET /monsters" first to get monster IDs for testing');
                return;
            }

            const monsterId = testMonsterIds[0];
            await testApi('POST', '/api/game-state/following/remove', 
                { monster_id: monsterId }, 'removeFollowingResult');
        }

        async function testChooseDoor(doorChoice) {
            const resultId = doorChoice === 'exit' ? 'doorExitResult' : 
                           doorChoice === 'location_1' ? 'doorChoice1Result' : 'doorChoice2Result';
            
            await testApi('POST', '/api/dungeon/choose-door', 
                { door_choice: doorChoice }, resultId);
        }

        // Run all tests in sequence
        async function runAllTests() {
            const button = document.getElementById('runAllTests');
            button.disabled = true;
            button.textContent = 'üîÑ Running Tests...';

            try {
                // Test monsters first to get IDs
                await testApi('GET', '/api/monsters?limit=5', {}, 'monstersListResult');
                await sleep(500);

                // Game state tests
                await testApi('GET', '/api/game-state', {}, 'gameStateResult');
                await sleep(500);
                await testApi('POST', '/api/game-state/reset', {}, 'resetGameResult');
                await sleep(500);
                await testApi('GET', '/api/game-state/following', {}, 'followingResult');
                await sleep(500);
                await testApi('GET', '/api/game-state/party', {}, 'partyResult');
                await sleep(500);
                await testApi('GET', '/api/game-state/party/ready', {}, 'partyReadyResult');
                await sleep(500);

                // Party management tests
                await testAddMonsterToFollowing();
                await sleep(500);
                await testSetParty();
                await sleep(500);

                // Dungeon tests
                await testApi('GET', '/api/dungeon/status', {}, 'dungeonStatusResult');
                await sleep(500);
                await testApi('GET', '/api/dungeon/state', {}, 'dungeonStateResult');
                await sleep(500);
                await testApi('POST', '/api/dungeon/enter', {}, 'dungeonEnterResult');
                await sleep(500);

                // Door choice tests (these may fail if not in dungeon)
                await testChooseDoor('location_1');
                await sleep(500);

                await testApi('GET', '/api/monsters/stats', {}, 'monstersStatsResult');

            } finally {
                button.disabled = false;
                button.textContent = '‚úÖ Tests Complete';
                setTimeout(() => {
                    button.textContent = 'üöÄ Run All Tests';
                }, 3000);
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function clearResults() {
            const results = document.querySelectorAll('.result');
            results.forEach(result => {
                result.style.display = 'none';
                result.textContent = '';
            });
        }

        // Event listeners
        document.getElementById('runAllTests').addEventListener('click', runAllTests);
        document.getElementById('clearResults').addEventListener('click', clearResults);

        // Initial load message
        console.log('üéÆ Monster Hunter API Test Suite Loaded');
        console.log('Click "Run All Tests" to test all endpoints, or test individual APIs');
    </script>
</body>
</html>